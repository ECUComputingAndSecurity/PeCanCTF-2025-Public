# minimal global tweaks
worker_processes  1;

events { worker_connections  1024; }

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # we need plain text for sub_filter to work
    gzip off;

    #
    # ---------- 1. Public site (default host) ----------
    #
    server {
        listen      8080 default_server;
        server_name _;                 # any host that isn’t caught later
        root  /usr/share/nginx/html/public-site;

        # main.css is *always* served from /common/*
        location = /main.css {
            alias /usr/share/nginx/html/common/main.css;
        }

        # everything else → site, falling back to index.html
        location / {
            try_files $uri $uri/ /index.html;

            # fix broken “../common/” URLs at response time
            sub_filter_types  text/html text/css application/javascript;
            sub_filter_once   off;
            sub_filter        "../common/" "/";
        }
    }

    #
    # ---------- 2. Intranet (internal) ----------
    #
    server {
        listen      8080;
        server_name intranet.byterunner;
        root  /usr/share/nginx/html/internal-site;

        location = /main.css {
            alias /usr/share/nginx/html/common/main.css;
        }

        location / {
            try_files $uri $uri/ /index.html;

            sub_filter_types  text/html text/css application/javascript;
            sub_filter_once   off;
            sub_filter        "../common/" "/";
        }
    }
}
